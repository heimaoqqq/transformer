# UNetå†…éƒ¨ç»´åº¦ä¸åŒ¹é…ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

å³ä½¿æ¡ä»¶ç¼–ç å™¨å’ŒUNetçš„cross_attention_diméƒ½æ˜¯512ï¼Œä»ç„¶å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
RuntimeError: The size of tensor a (512) must match the size of tensor b (1024) at non-singleton dimension 1
```

é”™è¯¯å‘ç”Ÿåœ¨æ³¨æ„åŠ›å±‚çš„æ®‹å·®è¿æ¥ä¸­ï¼š`attn_output + hidden_states`

## ğŸ” é—®é¢˜åˆ†æ

### è§‚å¯Ÿåˆ°çš„ç°è±¡ï¼š
1. **é…ç½®æ˜¾ç¤ºåŒ¹é…**ï¼š
   ```
   UNeté…ç½®ä¿¡æ¯:
     - cross_attention_dim: 512
   æ¡ä»¶ç¼–ç å™¨å®é™…é…ç½®:
     - åµŒå…¥ç»´åº¦: 512
     - UNetæœŸæœ›ç»´åº¦: 512
   ```

2. **ä½†è¿è¡Œæ—¶ä»ç„¶å‡ºé”™**ï¼šé”™è¯¯æ˜¾ç¤º512 vs 1024çš„ç»´åº¦ä¸åŒ¹é…

### å¯èƒ½çš„åŸå› ï¼š

1. **UNetå†…éƒ¨ç¡¬ç¼–ç ç»´åº¦**ï¼š
   - UNetå†…éƒ¨æŸäº›å±‚å¯èƒ½æœ‰ç¡¬ç¼–ç çš„1024ç»´åº¦
   - è¿™äº›å±‚æœŸæœ›1024ç»´è¾“å…¥ï¼Œä½†æ”¶åˆ°512ç»´

2. **attention_head_dimé…ç½®é—®é¢˜**ï¼š
   - `cross_attention_dim` ä¸ `attention_head_dim` ä¸å…¼å®¹
   - å¯¼è‡´å†…éƒ¨è®¡ç®—å‡ºç°1024ç»´åº¦

3. **æ¨¡å‹è®­ç»ƒæ—¶é…ç½®ä¸ä¸€è‡´**ï¼š
   - UNetå¯èƒ½å®é™…ä¸Šæ˜¯ç”¨1024ç»´è®­ç»ƒçš„
   - ä½†é…ç½®æ–‡ä»¶æ˜¾ç¤ºä¸º512ç»´

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¸´æ—¶ä¿®å¤ï¼šå¼ºåˆ¶ä½¿ç”¨1024ç»´

ä¿®å¤åçš„ä»£ç ä¼šï¼š
1. **æ£€æµ‹512ç»´é…ç½®**
2. **è‡ªåŠ¨åˆ‡æ¢åˆ°1024ç»´**
3. **ä½¿ç”¨éšæœºåˆå§‹åŒ–æƒé‡**ï¼ˆå› ä¸ºæ— æ³•åŠ è½½512ç»´æƒé‡åˆ°1024ç»´æ¨¡å‹ï¼‰

### ä¿®å¤é€»è¾‘ï¼š

```python
# æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶ä½¿ç”¨1024ç»´ (ä¸´æ—¶ä¿®å¤)
if actual_embed_dim == 512 and self.unet.config.cross_attention_dim == 512:
    # å°è¯•ä½¿ç”¨1024ç»´æ¥è§£å†³å†…éƒ¨ç»´åº¦ä¸åŒ¹é…é—®é¢˜
    print(f"ğŸ”§ æ£€æµ‹åˆ°512ç»´é…ç½®ï¼Œå°è¯•ä½¿ç”¨1024ç»´è§£å†³å†…éƒ¨ç»´åº¦é—®é¢˜...")
    print(f"âš ï¸  æ³¨æ„ï¼šè¿™å°†å¿½ç•¥é¢„è®­ç»ƒçš„æ¡ä»¶ç¼–ç å™¨æƒé‡")
    actual_embed_dim = 1024
    condition_encoder_state = None  # ä¸åŠ è½½512ç»´çš„æƒé‡

# åˆ›å»º1024ç»´çš„æ¡ä»¶ç¼–ç å™¨
self.condition_encoder = UserConditionEncoder(
    num_users=num_users,
    embed_dim=1024  # ä½¿ç”¨1024ç»´
)

# æƒé‡åŠ è½½å¤„ç†
if condition_encoder_state is not None:
    try:
        self.condition_encoder.load_state_dict(condition_encoder_state)
        print(f"âœ… æˆåŠŸåŠ è½½æ¡ä»¶ç¼–ç å™¨æƒé‡")
    except Exception as e:
        print(f"âš ï¸  æ— æ³•åŠ è½½æ¡ä»¶ç¼–ç å™¨æƒé‡: {e}")
        print(f"   å°†ä½¿ç”¨éšæœºåˆå§‹åŒ–çš„æƒé‡")
else:
    print(f"âš ï¸  ä½¿ç”¨éšæœºåˆå§‹åŒ–çš„æ¡ä»¶ç¼–ç å™¨æƒé‡")
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### æƒé‡åˆå§‹åŒ–é—®é¢˜ï¼š
- **éšæœºæƒé‡**ï¼šæ¡ä»¶ç¼–ç å™¨å°†ä½¿ç”¨éšæœºåˆå§‹åŒ–çš„æƒé‡
- **å¯èƒ½å½±å“è´¨é‡**ï¼šç”Ÿæˆçš„å›¾åƒè´¨é‡å¯èƒ½ä¸å¦‚ä½¿ç”¨é¢„è®­ç»ƒæƒé‡
- **éœ€è¦å¾®è°ƒ**ï¼šç†æƒ³æƒ…å†µä¸‹åº”è¯¥é‡æ–°è®­ç»ƒæˆ–å¾®è°ƒæ¡ä»¶ç¼–ç å™¨

### ä¸´æ—¶æ€§è´¨ï¼š
- è¿™æ˜¯ä¸€ä¸ª**ä¸´æ—¶ä¿®å¤**æ–¹æ¡ˆ
- ç›®çš„æ˜¯è®©æ¨ç†ä»£ç èƒ½å¤Ÿè¿è¡Œ
- **ä¸æ˜¯æœ€ç»ˆè§£å†³æ–¹æ¡ˆ**

## ğŸš€ ä½¿ç”¨æ–¹æ³•

ä¿®å¤åçš„ä»£ç ä¼šè‡ªåŠ¨å¤„ç†ç»´åº¦é—®é¢˜ï¼š

```bash
python inference/generate.py \
    --vae_path "/kaggle/input/final-model" \
    --unet_path "/kaggle/input/diffusion-final-model" \
    --condition_encoder_path "/kaggle/input/diffusion-final-model/condition_encoder.pt" \
    --num_users 31 \
    --user_ids 1 5 10 15 \
    --num_images_per_user 16 \
    --num_inference_steps 100 \
    --guidance_scale 7.5 \
    --device auto \
    --output_dir "/kaggle/working/generated_images"
```

## ğŸ“‹ é¢„æœŸè¾“å‡º

```
ğŸš€ è‡ªåŠ¨æ£€æµ‹åˆ°CUDAè®¾å¤‡ï¼Œä½¿ç”¨GPUåŠ é€Ÿ
Loading VAE...
Loading UNet...
UNeté…ç½®ä¿¡æ¯:
  - cross_attention_dim: 512
  - in_channels: 4
  - sample_size: 32
Loading Condition Encoder...
æ¡ä»¶ç¼–ç å™¨å®é™…é…ç½®:
  - ç”¨æˆ·æ•°: 31
  - åµŒå…¥ç»´åº¦: 512
  - UNetæœŸæœ›ç»´åº¦: 512
ğŸ”§ æ£€æµ‹åˆ°512ç»´é…ç½®ï¼Œå°è¯•ä½¿ç”¨1024ç»´è§£å†³å†…éƒ¨ç»´åº¦é—®é¢˜...
âš ï¸  æ³¨æ„ï¼šè¿™å°†å¿½ç•¥é¢„è®­ç»ƒçš„æ¡ä»¶ç¼–ç å™¨æƒé‡
âš ï¸  ä½¿ç”¨éšæœºåˆå§‹åŒ–çš„æ¡ä»¶ç¼–ç å™¨æƒé‡
Generator initialized with ddim scheduler
Generating images for users: [1, 5, 10, 15]
```

## ğŸ” è¿›ä¸€æ­¥è°ƒè¯•

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œå¯ä»¥ä½¿ç”¨è°ƒè¯•å·¥å…·ï¼š

```bash
# è¯¦ç»†åˆ†æUNetå†…éƒ¨é…ç½®
python debug_unet_internal.py

# åˆ†ææ³¨æ„åŠ›å¤´ç»´åº¦é—®é¢˜
python fix_attention_head_dim.py
```

## ğŸ’¡ é•¿æœŸè§£å†³æ–¹æ¡ˆ

1. **é‡æ–°è®­ç»ƒæ¡ä»¶ç¼–ç å™¨**ï¼š
   - ä½¿ç”¨1024ç»´é‡æ–°è®­ç»ƒæ¡ä»¶ç¼–ç å™¨
   - ç¡®ä¿ä¸UNetçš„å®é™…éœ€æ±‚åŒ¹é…

2. **æ£€æŸ¥UNetè®­ç»ƒé…ç½®**ï¼š
   - ç¡®è®¤UNetè®­ç»ƒæ—¶çš„å®é™…é…ç½®
   - å¯èƒ½éœ€è¦é‡æ–°è®­ç»ƒUNetä½¿ç”¨æ­£ç¡®çš„ç»´åº¦

3. **é…ç½®æ–‡ä»¶ä¿®å¤**ï¼š
   - ä¿®å¤UNeté…ç½®æ–‡ä»¶ä¸­çš„ä¸ä¸€è‡´é—®é¢˜
   - ç¡®ä¿æ‰€æœ‰é…ç½®å‚æ•°æ­£ç¡®

## ğŸ¯ æ€»ç»“

è¿™ä¸ªä¿®å¤æ–¹æ¡ˆé€šè¿‡å¼ºåˆ¶ä½¿ç”¨1024ç»´æ¡ä»¶ç¼–ç å™¨æ¥è§£å†³UNetå†…éƒ¨çš„ç»´åº¦ä¸åŒ¹é…é—®é¢˜ã€‚è™½ç„¶ä¼šä½¿ç”¨éšæœºæƒé‡ï¼Œä½†è‡³å°‘èƒ½è®©æ¨ç†ä»£ç è¿è¡Œèµ·æ¥ï¼Œä¸ºè¿›ä¸€æ­¥çš„è°ƒè¯•å’Œä¿®å¤æä¾›åŸºç¡€ã€‚
